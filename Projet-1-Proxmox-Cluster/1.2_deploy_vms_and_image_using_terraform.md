

# Deploying an Ephemeral Kubernetes Lab with Proxmox + Terraform

As a DevOps learner preparing for the CKA and CKS certifications, I needed a safe, reproducible environment where I could spin up and tear down Kubernetes clusters quickly. I didn’t want to rely on cloud resources (to save cost), so I decided to leverage my Proxmox VE homelab. By integrating Terraform, I gained Infrastructure-as-Code capabilities to automate ephemeral lab deployments.

Why Ephemeral Kubernetes Labs?
* Practice-focused: Spin up a cluster, experiment, destroy, and repeat.
* Isolation: Each cluster is self-contained, so I don’t risk breaking long-lived systems.
* Automation: Terraform guarantees that every lab has a consistent setup.

## Prerequisites

- Administrator access to a Proxmox VE node (v7/v8).
- Terraform installed (>= 1.3 recommended).
- Terraform provider `bpg/proxmox`.
- A VM template ready for Cloud-Init (with `qemu-guest-agent` installed and enabled).

## 1) Create a minimal role for Terraform

Adjust privileges if needed (dedicated pool, specific storage, etc.). The role below works for most VM create/manage operations performed by Terraform.

```
pveum role add TerraformProv -privs "Datastore.Allocate Datastore.AllocateSpace Datastore.Audit Pool.Allocate Sys.Audit Sys.Console Sys.Modify VM.Allocate VM.Audit VM.Clone VM.Config.CDROM VM.Config.Cloudinit VM.Config.CPU VM.Config.Disk VM.Config.HWType VM.Config.Memory VM.Config.Network VM.Config.Options VM.Console VM.Migrate VM.Monitor VM.PowerMgmt SDN.Use Datastore.AllocateTemplate"
```

## 2) Create a dedicated user

You can use the `pve` realm (local Proxmox) or `pam`.

```
pveum user add terraform@pve -comment "Terraform user"
```

## 3) Assign the role via an ACL

For the whole cluster (broader scope):

```
pveum aclmod / -user terraform@pve -role TerraformProv
```

For a specific pool (recommended least privilege), replace `<POOL>`:

```
pveum aclmod /pool/<POOL> -user terraform@pve -role TerraformProv
```

## 4) Create an API token for the user

The secret is shown only once. Store it safely. The `--privsep 0` option makes the token inherit the user's privileges.

```
pveum user token add terraform@pve terraform-token --comment "Terraform Token" --privsep 0
```

Notes:
- Token ID (example): `terraform@pve!terraform-token`
- Token secret: string shown only once

Revoke the token if needed:

```
pveum user token remove terraform@pve terraform-token
```

## 5) Configure authentication in Terraform

The BPG provider supports the following environment variables:

```
export PROXMOX_VE_ENDPOINT="https://<PVE_HOST>:8006/"
export PROXMOX_VE_API_TOKEN='<USER>@<REALM>!<TOKEN_ID>=<TOKEN_SECRET>'
# example: PROXMOX_VE_API_TOKEN='terraform@pve!terraform-token=a3a21970-e377-4d2a-a904-d7d4a0e9e16a'
export PROXMOX_VE_INSECURE=true
```

Or configure them as Terraform variables (see the example below).

## 6) Example Terraform provider configuration

```
terraform {
    required_providers {
        proxmox = {
            source  = "bpg/proxmox"
            version = "0.83.2"
        }
    }
}

provider "proxmox" {
    ssh {
        agent    = true
        username = "root" # or "terraform" if that account exists on the Proxmox node
    }
}
```

## 7) Configure variable files:

The first part of `variables.tf` is **pve_nodes**, used to deploy the Ubuntu cloud image:

```
variable "pve_nodes" {
  description = "List of Proxmox nodes (preference order)"
  type        = list(string)
  default     = [
    "pve-node1",
    "pve-node2",
    "pve-node3",
  ]
}
```

The second part is **servers**, used for VM configuration:

```
variable "servers" {
  type = list(object({
    name          = string
    node_name     = string
    ipv4_address  = string
    ipv4_gateway  = string
    ipv6_address  = string
    ipv6_gateway  = string
    disk_size     = number
    cpu_core      = number
    memory        = number
  }))

  default = [
    { name = "k8s-master"
      node_name    = "pve-node1"
      ipv4_address = "192.168.100.10/24"
      ipv4_gateway = "192.168.100.1"
      ipv6_address = "fd00:100::10/64"
      ipv6_gateway = "fd00:100::1"
      disk_size    = 25
      cpu_core     = 2
      memory       = 1024
    },
    { name = "k8s-worker1"
      node_name    = "pve-node2"
      ipv4_address = "192.168.100.11/24"
      ipv4_gateway = "192.168.100.1"
      ipv6_address = "fd00:100::11/64"
      ipv6_gateway = "fd00:100::1"
      disk_size    = 25
      cpu_core     = 2
      memory       = 1024
    },
    { name = "k8s-worker2"
      node_name    = "pve-node3"
      ipv4_address = "192.168.100.12/24"
      ipv4_gateway = "192.168.100.1"
      ipv6_address = "fd00:100::12/64"
      ipv6_gateway = "fd00:100::1"
      disk_size    = 25
      cpu_core     = 2
      memory       = 1024
    },
  ]
}
```

## 8) create vps on proxmox

```
terraform init
terraform plan
terraform apply
```

<div>
  <center><img src="./screenshot/10-terraform.gif" alt="Interface VXLAN" style="width:50%;"/><center/>
</div>
